<script>
/* ============  EDIT PRODUCT HANDLER  ============ */
let editingProductId = null;   // current product being edited

document.addEventListener('click', e => {
  const editBtn = e.target.closest('.edit-product-btn');
  if (!editBtn) return;

  editingProductId = parseInt(editBtn.dataset.id);
  const product = products.find(p => p.id === editingProductId);
  if (!product) return;

  // --- populate the form with existing data ---
  document.getElementById('product-name').value        = product.name;
  document.getElementById('product-price').value       = product.price;
  document.getElementById('product-category').value    = product.category;
  document.getElementById('product-stock').value       = product.stock;
  document.getElementById('product-description').value = product.description;
  document.getElementById('product-image-url').value   = product.image || '';
  document.getElementById('image-preview').innerHTML   = product.image ? `<img src="${product.image}" class="max-w-32 max-h-32 object-cover rounded-xl">` : '';

  // --- colours ---
  const colorsSection = document.getElementById('colors-section');
  colorsSection.innerHTML = '';        // wipe old colour rows
  colorFieldCount = 0;

  if (product.colors && product.colors.length) {
    product.colors.forEach((c, idx) => {
      addColorField();
      document.getElementById(`color-name-${idx}`).value  = c.name;
      document.getElementById(`color-code-${idx}`).value  = c.code;
      document.getElementById(`color-price-${idx}`).value = c.price;
    });
  } else {
    addColorField();  // keep one empty row
  }

  // --- show the form ---
  document.getElementById('add-product-form').style.display = 'block';
});


/* ============  OVERRIDE SAVE  ============ */
const realSaveBtn = document.getElementById('save-product-btn');
realSaveBtn.replaceWith(realSaveBtn.cloneNode(true)); // remove old listeners
document.getElementById('save-product-btn').addEventListener('click', () => {

  const name        = document.getElementById('product-name').value.trim();
  const price       = parseFloat(document.getElementById('product-price').value);
  const category    = document.getElementById('product-category').value;
  const stock       = parseInt(document.getElementById('product-stock').value);
  const description = document.getElementById('product-description').value.trim();
  const imageUrl    = document.getElementById('product-image-url').value.trim();

  if (!name || !price || !category || isNaN(stock) || !description) {
    showNotification('Please fill all required fields', 'error');
    return;
  }

  // collect colours
  const colors = [];
  for (let i = 0; i < colorFieldCount; i++) {
    const n = document.getElementById(`color-name-${i}`);
    const c = document.getElementById(`color-code-${i}`);
    const p = document.getElementById(`color-price-${i}`);
    if (n && n.value && c && p && p.value) {
      colors.push({ name: n.value, code: c.value, price: parseFloat(p.value) });
    }
  }

  // build product object
  const productData = {
    name,
    price,
    category,
    description,
    stock,
    image: imageUrl,
    colors,
    rating: 0,
    reviews: 0,
    features: []
  };

  if (editingProductId) {
    // update existing product
    const idx = products.findIndex(p => p.id === editingProductId);
    products[idx] = { ...products[idx], ...productData };
    showNotification('Product updated successfully!', 'success');
  } else {
    // brand-new product
    products.push({ id: Date.now(), ...productData });
    showNotification('Product added successfully!', 'success');
  }

  saveProducts();
  displayProducts();
  displayAdminProducts();
  updateAdminStats();

  // reset state
  editingProductId = null;
  document.getElementById('add-product-form').style.display = 'none';
});
</script>
